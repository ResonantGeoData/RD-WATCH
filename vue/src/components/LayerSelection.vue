<script setup lang="ts">
import { computed, onMounted } from "vue";
import { ApiService } from "../client";
import { state } from "../store";
import { useRoute } from 'vue-router';



const scoringApp = computed(()=> ApiService.getApiPrefix().includes('scoring'));
const route = useRoute();
const proposals = computed(() => route.path.includes('proposals'));


const toggleGroundTruth = (id: string) => {
  if (state.filters.drawObservations?.includes('groundtruth') || state.filters.drawSiteOutline?.includes('groundtruth')) {
        if (state.openedModelRuns) {
          state.openedModelRuns.add(id);
        }
        const configuration_id = Array.from(state.openedModelRuns);
        state.filters = { ...state.filters, configuration_id};
      }
      else if (!state.filters.drawObservations?.includes('groundtruth') && !state.filters.drawSiteOutline?.includes('groundtruth')) {
        if (state.openedModelRuns) {
          state.openedModelRuns.delete(id);
        }
        const configuration_id = Array.from(state.openedModelRuns);
        state.filters = { ...state.filters, configuration_id};
      }

}

onMounted(() => {
  // For proposal view we default to sites
  if (proposals.value) {
    const drawObservations = undefined;
    const drawSiteOutline = ['model'];
    state.filters = { ...state.filters, drawSiteOutline, drawObservations, scoringColoring: undefined, siteTimeLimits: undefined };

  }
})

const checkGroundTruth = async () => {
  if (scoringApp.value) {
    return;
  } else if (proposals.value) {
    // We need to get the groundTruth value and toggle that instead.
    if (state.proposals.ground_truths) {
      const id = state.proposals.ground_truths;
      toggleGroundTruth(id);
    }
  } else {
    // We need to find the ground-truth model and add it to the visible items
    const performer = state.filters.performer_ids?.map((item) => state.performerMapping[item].short_code)
    const request = await ApiService.getModelRuns({
      limit: 10,
      performer,
      region: state.filters.regions? state.filters.regions[0] : '',
      groundtruth: true
    });
    if (request.items.length) {
      const id = request.items[0].id;
      toggleGroundTruth(id)
    }
  }
}

const toggleObs = (type?: undefined | 'model' | 'groundtruth') => {
  let val;
  let copy = state.filters.drawObservations;
  if (type === undefined) {
    val = !state.filters.drawObservations ? ['model', 'groundtruth'] : undefined;
  } else {
    if (copy) {
        const index = copy.indexOf(type);
        if (index !== -1 ) {
            copy.splice(index, 1);
        } else {
            copy.push(type);
        }
    } else {
        copy = [type];
    }
    val = copy;
    if (val?.length === 0) {
        val = undefined;
    }
  }
  state.filters = { ...state.filters, drawObservations: val, scoringColoring: undefined };
  checkGroundTruth();
}

const toggleSite = (type?: undefined | 'model' | 'groundtruth') => {
    let val;
  let copy = state.filters.drawSiteOutline;
  if (type === undefined) {
    val = !state.filters.drawSiteOutline ? ['model', 'groundtruth'] : undefined;

  } else {
    if (copy) {
        const index = copy.indexOf(type);
        if (index !== -1 ) {
            copy.splice(index, 1);
        } else {
            copy.push(type);
        }
    } else {
        copy = [type];
    }
    val = copy;
    if (val?.length === 0) {
        val = undefined;
    }
  }
  state.filters = { ...state.filters, drawSiteOutline: val, scoringColoring: undefined, siteTimeLimits: undefined };
  checkGroundTruth();
}

const toggleSiteTimeLimits = () => {
    state.filters = { ...state.filters, siteTimeLimits: !state.filters.siteTimeLimits, scoringColoring: undefined };

}

const toggleRegion = () => {
  const val = !state.filters.drawRegionPoly;
  state.filters = { ...state.filters, drawRegionPoly: val };
}

const toggleScoring = (data? : undefined | 'simple' | 'detailed') => {
  let val = state.filters.scoringColoring ? undefined : 'simple';
  if (data) {
    val = data;
  }
  if (val !== undefined) {
    // We turn off other state;
    state.filters = { ...state.filters, drawObservations: undefined, drawSiteOutline: undefined}

  }
  state.filters = { ...state.filters, scoringColoring: val as 'simple' | 'detailed' | undefined };
}

</script>

<template>
  <v-row
    dense
    class="base"
  >
    <v-menu
      open-on-hover
    >
      <template #activator="{ props }">
        <v-btn
          class="px-2 mx-2"
          v-bind="props"
          size="large"
          :color="state.filters.drawObservations ? 'primary' : ''"
          style="min-width: 200px"
          @click="toggleObs()"
        >
          <span>
            Observations
          </span>
          <div
            v-if="state.filters.drawObservations?.includes('model')"
            class="layer-icon mx-1"
          >
            M
          </div>
          <div
            v-if="state.filters.drawObservations?.includes('groundtruth')"
            class="layer-icon mx-1"
          >
            G
          </div>
        </v-btn>
      </template>
      <v-card outlined>
        <v-list>
          <v-list-item
            value="All"
            class="rootItem"
            @click="toggleObs()"
          >
            <v-row
              dense
              align="center"
              class="pa-0 ma-0"
            >
              <v-spacer />
              <v-checkbox
                :model-value="state.filters.drawObservations?.includes('model') && state.filters.drawObservations?.includes('groundtruth')"
                density="compact"
                hide-details
                class="item-checkbox"
              />
            </v-row>
          </v-list-item>
          <v-list-item
            value="Model"
            @click="toggleObs('model')"
          >
            <div
              class="layer-icon pl-1"
            >
              M
            </div>
            <div
              class="layer-text"
            >
              Model
            </div>
            <v-checkbox-btn
              :model-value="state.filters.drawObservations?.includes('model')"
              density="compact"
              hide-details
              readonly
              class="item-checkbox"
            />
          </v-list-item>
          <v-list-item
            value="GroundTruth"
            @click="toggleObs('groundtruth')"
          >
            <div
              class="layer-icon pl-1"
            >
              G
            </div>
            <div
              class="layer-text"
            >
              GroundTruth
            </div>
            <v-checkbox-btn
              :model-value="state.filters.drawObservations?.includes('groundtruth')"
              density="compact"
              hide-details
              readonly
              class="item-checkbox"
            />
          </v-list-item>
        </v-list>
      </v-card>
    </v-menu>
    <v-menu
      open-on-hover
    >
      <template #activator="{ props }">
        <v-btn
          class="px-2 mx-2"
          v-bind="props"
          size="large"
          :color="state.filters.drawSiteOutline ? 'primary' : ''"
          style="min-width:150px"
          @click="toggleSite()"
        >
          <span>
            Sites
          </span>
          <div
            v-if="state.filters.drawSiteOutline?.includes('model')"
            class="layer-icon mx-1"
          >
            M
          </div>
          <div
            v-if="state.filters.drawSiteOutline?.includes('groundtruth')"
            class="layer-icon mx-1"
          >
            G
          </div>
          <div
            v-if="state.filters.siteTimeLimits"
            class="layer-icon mx-1"
          >
            T
          </div>
        </v-btn>
      </template>
      <v-card outlined>
        <v-list>
          <v-list-item
            value="All"
            class="rootItem"
            @click="toggleSite()"
          >
            <v-row
              dense
              align="center"
              class="pa-0 ma-0"
            >
              <v-spacer />
              <v-checkbox
                :model-value="state.filters.drawSiteOutline?.includes('model') && state.filters.drawSiteOutline?.includes('groundtruth')"
                density="compact"
                hide-details
                class="item-checkbox"
              />
            </v-row>
          </v-list-item>
          <v-list-item
            value="Model"
            @click="toggleSite('model')"
          >
            <div
              class="layer-icon pl-1"
            >
              M
            </div>
            <div
              class="layer-text"
            >
              Model
            </div>
            <v-checkbox-btn
              :model-value="state.filters.drawSiteOutline?.includes('model')"
              density="compact"
              hide-details
              readonly
              class="item-checkbox"
            />
          </v-list-item>
          <v-list-item
            value="GroundTruth"
            @click="toggleSite('groundtruth')"
          >
            <div
              class="layer-icon pl-1"
            >
              G
            </div>
            <div
              class="layer-text"
            >
              GroundTruth
            </div>
            <v-checkbox-btn
              :model-value="state.filters.drawSiteOutline?.includes('groundtruth')"
              density="compact"
              hide-details
              readonly
              class="item-checkbox"
            />
          </v-list-item>
          <v-list-item
            value="GroundTruth"
            @click="toggleSiteTimeLimits()"
          >
            <div
              class="layer-icon pl-1"
            >
              T
            </div>

            <div
              class="layer-text"
            >
              Time Limits
            </div>
            <v-checkbox-btn
              :model-value="state.filters.siteTimeLimits"
              density="compact"
              hide-details
              readonly
              class="item-checkbox"
            />
          </v-list-item>
        </v-list>
      </v-card>
    </v-menu>
    <v-btn
      class="px-2 mx-2"
      size="large"
      :color="state.filters.drawRegionPoly ? 'primary' : ''"
      @click="toggleRegion()"
    >
      Region
    </v-btn>
    <v-menu
      open-on-hover
    >
      <template #activator="{ props }">
        <v-btn
          v-if="scoringApp"
          class="px-2 mx-2"
          v-bind="props"
          size="large"
          :color="state.filters.scoringColoring ? 'primary' : ''"
          style="min-width:125px"
          @click="toggleScoring()"
        >
          <span>
            Scoring
          </span>
          <div
            v-if="state.filters.scoringColoring == 'simple'"
            class="layer-icon mx-1"
          >
            S
          </div>
          <div
            v-if="state.filters.scoringColoring == 'detailed'"
            class="layer-icon mx-1"
          >
            D
          </div>
        </v-btn>
      </template>
      <v-card outlined>
        <v-list>
          <v-list-item
            value="Simple"
            @click="toggleScoring('simple')"
          >
            <div
              class="layer-icon pl-1"
            >
              S
            </div>

            <div
              class="layer-text"
            >
              Simple
            </div>
            <v-radio
              :model-value="state.filters.scoringColoring == 'simple'"
              density="compact"
              hide-details
              readonly
              class="item-checkbox"
            />
          </v-list-item>
          <v-list-item
            value="Detailed"
            @click="toggleScoring('detailed')"
          >
            <div
              class="layer-icon pl-1"
            >
              D
            </div>
            <div
              class="layer-text"
            >
              Detailed
            </div>
            <v-radio
              :model-value="state.filters.scoringColoring == 'detailed'"
              density="compact"
              hide-details
              readonly
              class="item-checkbox"
            />
          </v-list-item>
        </v-list>
      </v-card>
    </v-menu>
  </v-row>
</template>

<style scoped>
.base {
    position: absolute;
    left: 650px;
    top:8px;
    margin-left: 10px;
}
.button-label {
    font-size: 8px;
}

.layer-text {
  text-transform: uppercase;
  font-size: 16px;
  display: inline;
  margin-left: 5px;
}

.layer-icon {
  color: #FFFFFF !important;
  background-color: #37474F;
  min-width: 30px !important;
  width:30px !important;
  height: 30px !important;
  min-height: 30px !important;
  max-width: 30px !important;
  max-height: 30px !important;
  border-radius: 5px !important;
  font-size: 20px !important;
  text-align: center !important;
  font-weight: 800 !important;
  line-height: 30px !important;
  display: inline;
}

.rootItem {
  border-bottom: 1px solid gray;
  height: 35px;
}

.item-checkbox {
  display:inline;
  float:right;
}
</style>
